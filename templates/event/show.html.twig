{% extends 'base.html.twig' %}

{% block title %}
	{{ event.title }}
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<h1>{{ event.title }}</h1>

		<div class="row mt-4">
			<div class="col-md-8">
				<p class="lead">{{ event.description }}</p>
				{% if event.imageName %}
					<img src="{{ asset('uploads/event/' ~ event.imageName) }}" alt="Image pour {{ event.title }}" class="img-fluid mb-4">
				{% endif %}
				<div class="row">
					<div class="col-md-6">
						<div class="card mb-3">
							<div class="card-body">
								<h5 class="card-title">D√©tails</h5>
								<ul class="list-unstyled">
									<li>üìÖ D√©but :
										{{ event.startDate|date('d/m/Y H:i') }}</li>
									<li>üèÅ Fin :
										{{ event.endDate|date('d/m/Y H:i') }}</li>
									<li>üìç Lieu :
										{{ event.location }}</li>
									<li>üë§ Organisateur :
										{{ event.organizer.pseudo }}</li>
									<li>üë• Participants :
										{{ event.attendees|length }}
										{% if event.maxAttendees %}/{{ event.maxAttendees }}
										{% endif %}
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>


		<div class="mt-4">
			{% if not event.isPast() %}
				{% if is_registered %}
					<form method="post" action="{{ path('app_event_unregister', {'id': event.id}) }}">
						<button class="btn btn-warning">Se d√©sinscrire</button>
					</form>
				{% else %}
					<form method="post" action="{{ path('app_event_register', {'id': event.id}) }}">
						<button class="btn btn-success" {{ not event.canRegister(app.user) ? 'disabled' : '' }}>
							S'inscrire
						</button>
					</form>
				{% endif %}

				{% if is_granted('edit', event) %}
					<div class="mt-3">
						<a href="{{ path('app_event_edit', {'id': event.id}) }}" class="btn btn-primary">
							Modifier
						</a>
						<form method="post" action="{{ path('app_event_delete', {'id': event.id}) }}" class="d-inline">
							<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ event.id) }}">
							<button class="btn btn-danger" onclick="return confirm('Supprimer cet √©v√©nement ?')">
								Supprimer
							</button>
						</form>
					</div>
				{% endif %}
			{% else %}
				<div class="alert alert-info mt-3">
					Cet √©v√©nement est termin√©. Les inscriptions et modifications ne sont plus possibles.
				</div>
			{% endif %}
		</div>
	</div>

	{% if app.user == event.organizer %}
		<section class="mt-5">
			<h3>Liste des participants ({{ event.attendees|length }}/{{ event.maxAttendees ?? '‚àû' }})</h3>
			<div class="list-group">
				{% for attendee in attendees %}
					<div class="list-group-item">
						{{ attendee.pseudo }}
						{% if attendee == app.user %}
							<span class="badge bg-primary">Vous</span>
						{% endif %}
					</div>
				{% else %}
					<div class="list-group-item text-muted">
						Aucun participant pour le moment
					</div>
				{% endfor %}
			</div>
		</section>
	{% endif %}
	{# Section des notes #}
	<div class="rating-section mt-5">
		<div class="average-rating alert alert-info">
			<h4>Note moyenne :
				{{ averageRating|number_format(1) }}/5</h4>
			<small>Bas√© sur
				{{ ratings|length }}
				√©valuation(s)</small>
		</div>

		{% if ratings|length > 0 %}
			<div class="user-ratings">
				<h4>Avis des utilisateurs :</h4>
				{% for rating in ratings %}
					<div class="card rating-card mb-3">
						<div class="card-body">
							<div class="star-rating-static text-warning">
								{% for i in 1..5 %}
									{% if i <= rating.score %}
										<span class="text-warning">‚òÖ</span>
									{% else %}
										<span class="text-muted">‚òÖ</span>
									{% endif %}
								{% endfor %}
							</div>
							{% if rating.comment %}
								<p class="mt-2">{{ rating.comment }}</p>
							{% endif %}
							<small class="text-muted">
								Par
								{{ rating.rater.pseudo }}, 
																																																																																																																																																																																																																																																																																																																																		le
								{{ rating.createdAt|date('d/m/Y') }}
							</small>
						</div>
					</div>
				{% endfor %}
			</div>
		{% endif %}

		{% if canRate %}
			<div class="rating-form mt-4">
				<h4>{{ existingRating ? 'Modifier votre' : 'Ajouter une' }}
					√©valuation</h4>

				{{ form_start(ratingForm) }}
				<div class="star-rating mb-3">
					{% for child in ratingForm.score|reverse %}
						<input type="radio" id="{{ child.vars.id }}" name="{{ child.vars.full_name }}" value="{{ child.vars.value }}" {{ child.vars.checked ? 'checked' : '' }} class="visually-hidden"/>
						<label for="{{ child.vars.id }}" title="{{ child.vars.label }}">
							<svg class="star" width="32" height="32" viewbox="0 0 24 24">
								<path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
							</svg>
						</label>
					{% endfor %}
				</div>
				{{ form_errors(ratingForm.score) }}
				{# Affiche les erreurs du score #}
				{{ form_row(ratingForm.comment) }}
				{{ form_rest(ratingForm) }}
				{# Inclut le token CSRF #}
				<button class="btn btn-primary">
					{{ existingRating ? 'Mettre √† jour' : 'Envoyer' }}
				</button>
				{{ form_end(ratingForm) }}
			</div>
		{% endif %}
	</div>
	<div class="mt-4">
		<a href="{{ path('app_event_index') }}" class="btn btn-secondary">
			Retour
		</a>
	</div>

{% endblock %}
{% block stylesheets %}
	<style>
		.star-rating {
			display: flex;
			gap: 5px;
			flex-direction: row-reverse;
			justify-content: flex-end;
		}

		.star-rating input {
			display: none;
		}

		.star-rating label {
			cursor: pointer;
			color: #ddd;
			transition: color 0.2s;
		}

		.star-rating label:hover,
		.star-rating label:hover ~ label {
			color: #ffd700;
		}

		.star-rating .star {
			fill: currentColor;
			width: 2.5em;
			height: 2.5em;
		}
		h1 {
			color: #2E7D32;
			border-left: 4px solid #4CAF50;
			padding-left: 1rem;
			margin-bottom: 2rem;
		}

		/* Section d√©tails */
		.card.details-card {
			border: none;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(76, 175, 80, 0.1);
			overflow: hidden;
		}

		.details-card .card-title {
			color: #2E7D32;
			font-weight: 600;
			border-bottom: 2px solid #4CAF50;
			padding-bottom: 0.5rem;
			margin-bottom: 1.5rem;
		}

		.details-card ul li {
			padding: 0.5rem 0;
			display: flex;
			align-items: center;
			gap: 0.75rem;
		}

		.details-card ul li::before {
			content: '';
			display: inline-block;
			width: 24px;
			height: 24px;
			background-size: contain;
		}

		li:nth-child(1)::before {
			background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='%234CAF50'%3E%3Cpath d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z'/%3E%3C/svg%3E");
		}
		li:nth-child(2)::before {
			background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='%234CAF50'%3E%3Cpath d='M17 10H7v2h10v-2zm2-7h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z'/%3E%3C/svg%3E");
		}
		li:nth-child(3)::before {
			background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='%234CAF50'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E");
		}
		li:nth-child(4)::before {
			background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='%234CAF50'%3E%3Cpath d='M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z'/%3E%3C/svg%3E");
		}

		/* Image principale */
		.event-image {
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			margin: 2rem 0;
			transition: transform 0.3s ease;
		}

		.event-image:hover {
			transform: translateY(-3px);
		}

		/* Boutons */
		.action-buttons {
			display: flex;
			gap: 1rem;
			flex-wrap: wrap;
			margin: 2rem 0;
		}

		.btn-success {
			background: linear-gradient(135deg, #4CAF50, #2E7D32);
			border: none;
			padding: 0.75rem 1.5rem;
			border-radius: 8px;
		}

		.btn-warning {
			background: linear-gradient(135deg, #FFC107, #FF9800);
			border: none;
		}

		/* Section participants */
		.participants-section {
			background: #f8f9fa;
			border-radius: 12px;
			padding: 2rem;
			margin-top: 3rem;
		}

		.list-group-item {
			border: none;
			border-bottom: 1px solid #e9ecef;
			padding: 1rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.badge.bg-primary {
			background: linear-gradient(135deg, #2196F3, #1976D2) !important;
		}

		@media(max-width: 768px) {
			.row {
				flex-direction: column-reverse;
			}

			.col-md-8 {
				margin-bottom: 2rem;
			}
		}
	</style>
{% endblock %}
{% block javascripts %}
	<script>
		document.querySelectorAll('.star-rating').forEach(container => {
const stars = container.querySelectorAll('input');
stars.forEach(star => { // Initialisation bas√©e sur l'√©toile coch√©e
if (star.checked) {
highlightStars(stars, parseInt(star.value));
}

star.addEventListener('change', () => {
const selectedValue = parseInt(star.value);
highlightStars(stars, selectedValue);
});
});
});

function highlightStars(stars, selectedValue) {
stars.forEach(star => {
const label = star.nextElementSibling; // Le label suit l'input
const starValue = parseInt(star.value);
if (starValue <= selectedValue) {
label.querySelector('.star').style.fill = '#ffd700';
} else {
label.querySelector('.star').style.fill = '#ddd';
}
});
}
	</script>
{% endblock %}
