{% extends 'base.html.twig' %}

{% block title %}
	{{ forum.title }}
{% endblock %}

{% block stylesheets %}
	<style>
		.response-rating {
			position: relative;
			padding-left: 100px;
		}
		.rating-badge {
			position: absolute;
			left: 0;
			top: 0;
			width: 80px;
			text-align: center;
			background: rgba(255, 215, 0, 0.1);
			border: 1px solid #ffd700;
			border-radius: 4px;
			padding: 5px;
		}
		.top-response {
			border: 2px solid #ffd700;
			background: #fffdf6;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}
		.star-rating {
			direction: rtl;
			display: inline-block;
		}
		.star-rating input[type="radio"] {
			display: none;
		}
		.star-rating label {
			color: #ccc;
			cursor: pointer;
			font-size: 1.2em;
		}
		.star-rating label:hover,
		.star-rating label:hover ~ label,
		.star-rating input[type="radio"]:checked ~ label {
			color: #ffd700;
		}
		.rating-badge {
			background: #f8f9fa;
			border: 1px solid #dee2e6;
			position: static;
			display: inline-block;
			margin-right: 1rem;
		}
		.star-rating label {
			font-size: 1.5rem;
			padding: 0 2px;
		}
		.collapse {
			transition: all 0.3s ease;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<div class="card">
			<div class="card-header">
				<h1>{{ forum.title }}</h1>
				<div class="meta text-muted">
					Par
					{{ forum.author.pseudo }}
					‚Ä¢
					{{ forum.createdAt|date('d/m/Y H:i') }}
					{% if forum.isOpen %}
						<span class="badge bg-success">Ouvert</span>
					{% else %}
						<span class="badge bg-danger">Ferm√©</span>
					{% endif %}
				</div>
			</div>

			<div class="card-body">
				<div class="forum-content mb-5">
					{{ forum.content|nl2br }}
				</div>
				{% if forum.imageName %}
					<img src="{{ asset('uploads/forum/' ~ forum.imageName) }}" alt="Image pour {{ forum.title }}" class="img-fluid mb-4">
				{% endif %}
				{% if topResponses|length > 0 %}
					<div class="top-responses mb-5">
						<h4>üåü R√©ponses les mieux not√©es</h4>
						{% for topResponse in topResponses %}
							{% set response = topResponse[0] %}
							{% set averageRating = topResponse.average %}
							<div class="card top-response mb-3">
								<div class="card-body">
									<div class="d-flex justify-content-between align-items-center mb-2">
										<div class="rating-badge">
											‚òÖ
											{{ averageRating|number_format(1) }}
										</div>
										<strong>{{ response.author.pseudo }}</strong>
										<small class="text-muted">
											{{ response.createdAt|date('d/m/Y H:i') }}
										</small>
									</div>
									<p class="mb-0">{{ response.content|nl2br }}</p>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}

				<div class="responses">
					<h4>{{ forum.responses|length }}
						r√©ponses</h4>

					{% for response in forum.responses %}
						<div class="card mb-4">
							<div class="card-body">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<div class="rating-badge">
										‚òÖ
										{{ averages[response.id]|number_format(1) }}
									</div>
									<strong>{{ response.author.pseudo }}</strong>
									<small class="text-muted">
										{{ response.createdAt|date('d/m/Y H:i') }}
									</small>
								</div>

								<p>{{ response.content|nl2br }}</p>

								<button class="btn btn-sm btn-info mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#ratings-{{ response.id }}">
									D√©tails
								</button>

								<div class="collapse" id="ratings-{{ response.id }}">
									<div class="card card-body">
										<h6>D√©tail des notes</h6>
										{% if response.ratings|length > 0 %}
											{% for rating in response.ratings %}
												<div class="mb-2">
													<div>
														<strong>{{ rating.rater.pseudo }}</strong>
														a donn√© ‚òÖ{{ rating.score }}
														{% if rating.comment %}
															:
															<em>"{{ rating.comment }}"</em>
														{% endif %}
													</div>
												</div>
											{% endfor %}
										{% else %}
											<div class="text-muted">Aucune note pour cette r√©ponse</div>
										{% endif %}
									</div>
								</div>

								{% if app.user and app.user != response.author and forum.isOpen %}
									<div class="rating-form mt-3">
										{{ form_start(responseForms[response.id]) }}
										<div class="star-rating">
											{% for i in range(5, 1, -1) %}
												<input type="radio" id="response{{ response.id }}_star{{ i }}" name="{{ responseForms[response.id].score.vars.full_name }}" value="{{ i }}" {{ responseForms[response.id].score.vars.value == i ? 'checked' : '' }}/>
												<label for="response{{ response.id }}_star{{ i }}">‚òÖ</label>
											{% endfor %}
										</div>
										{{ form_widget(responseForms[response.id].comment) }}
										<button class="btn btn-sm btn-outline-primary mt-2">
											{{ responseForms[response.id].vars.data.id ? 'Modifier' : 'Noter' }}
										</button>
										{{ form_end(responseForms[response.id]) }}
									</div>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				</div>

				{% if forum.isOpen %}
					<div class="add-response mt-5">
						<h4>Ajouter une r√©ponse</h4>
						{{ form_start(responseForm) }}
						{{ form_widget(responseForm.content, {
                        'attr': {
                            'class': 'form-control',
                            'rows': 5,
                            'placeholder': 'Votre r√©ponse...'
                        }
                    }) }}
						<button class="btn btn-primary mt-3">Publier</button>
						{{ form_end(responseForm) }}
					</div>
				{% else %}
					<div class="alert alert-warning mt-4">
						Cette discussion est ferm√©e aux nouvelles r√©ponses
					</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="mt-4">
		<a href="{{ path('app_forum_index') }}" class="btn btn-secondary">
			Retour
		</a>
	</div>
{% endblock %}
