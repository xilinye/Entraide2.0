{% extends 'base.html.twig' %}

{% block title %}
	{{ event.title }}
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<h1>{{ event.title }}</h1>

		<div class="row mt-4">
			<div class="col-md-8">
				<p class="lead">{{ event.description }}</p>

				<div class="row">
					<div class="col-md-6">
						<div class="card mb-3">
							<div class="card-body">
								<h5 class="card-title">Détails</h5>
								<ul class="list-unstyled">
									<li>📅 Début :
										{{ event.startDate|date('d/m/Y H:i') }}</li>
									<li>🏁 Fin :
										{{ event.endDate|date('d/m/Y H:i') }}</li>
									<li>📍 Lieu :
										{{ event.location }}</li>
									<li>👤 Organisateur :
										{{ event.organizer.pseudo }}</li>
									<li>👥 Participants :
										{{ event.attendees|length }}
										{% if event.maxAttendees %}/{{ event.maxAttendees }}
										{% endif %}
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="mt-4">


			<div class="mt-4">
				{% if not event.isPast() %}
					{% if is_registered %}
						<form method="post" action="{{ path('app_event_unregister', {'id': event.id}) }}">
							<button class="btn btn-warning">Se désinscrire</button>
						</form>
					{% else %}
						<form method="post" action="{{ path('app_event_register', {'id': event.id}) }}">
							<button class="btn btn-success" {{ not event.canRegister(app.user) ? 'disabled' : '' }}>
								S'inscrire
							</button>
						</form>
					{% endif %}

					{% if is_granted('edit', event) %}
						<div class="mt-3">
							<a href="{{ path('app_event_edit', {'id': event.id}) }}" class="btn btn-primary">
								Modifier
							</a>
							<form method="post" action="{{ path('app_event_delete', {'id': event.id}) }}" class="d-inline">
								<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ event.id) }}">
								<button class="btn btn-danger" onclick="return confirm('Supprimer cet événement ?')">
									Supprimer
								</button>
							</form>
						</div>
					{% endif %}
				{% else %}
					<div class="alert alert-info mt-3">
						Cet événement est terminé. Les inscriptions et modifications ne sont plus possibles.
					</div>
				{% endif %}
			</div>
		</div>

		{% if app.user == event.organizer %}
			<section class="mt-5">
				<h3>Liste des participants ({{ event.attendees|length }}/{{ event.maxAttendees ?? '∞' }})</h3>
				<div class="list-group">
					{% for attendee in attendees %}
						<div class="list-group-item">
							{{ attendee.pseudo }}
							{% if attendee == app.user %}
								<span class="badge bg-primary">Vous</span>
							{% endif %}
						</div>
					{% else %}
						<div class="list-group-item text-muted">
							Aucun participant pour le moment
						</div>
					{% endfor %}
				</div>
			</section>
		{% endif %}
		{# Section des notes #}
		<div class="rating-section mt-5">
			<div class="average-rating alert alert-info">
				<h4>Note moyenne :
					{{ averageRating|number_format(1) }}/5</h4>
				<small>Basé sur
					{{ ratings|length }}
					évaluation(s)</small>
			</div>

			{% if ratings|length > 0 %}
				<div class="ratings-list mt-4">
					<h5>Dernières évaluations :</h5>
					{% for rating in ratings %}
						<div class="card mb-3">
							<div class="card-body">
								<div class="star-rating">
									{% for i in 1..5 %}
										<span class="star {% if i <= rating.score %}filled{% endif %}">★</span>
									{% endfor %}
								</div>
								{% if rating.comment %}
									<p class="mt-2">{{ rating.comment }}</p>
								{% endif %}
								<small class="text-muted">
									Par
									{{ rating.rater.pseudo }}, 
									                            le
									{{ rating.createdAt|date('d/m/Y') }}
								</small>
							</div>
						</div>
					{% endfor %}
				</div>
			{% endif %}

			{% if canRate %}
				<div class="rating-form mt-4">
					<h4>{{ existingRating ? 'Modifier votre' : 'Ajouter une' }}
						évaluation</h4>
					{{ form_start(ratingForm) }}
					<div class="star-rating mb-3">
						{{ form_widget(ratingForm.score) }}
					</div>
					{{ form_row(ratingForm.comment) }}
					<button class="btn btn-primary">
						{{ existingRating ? 'Mettre à jour' : 'Envoyer' }}
					</button>
					{{ form_end(ratingForm) }}
				</div>
			{% endif %}
		</div>
		<div class="mt-4">
			<a href="{{ path('app_event_index') }}" class="btn btn-secondary">
				Retour
			</a>
		</div>
	{% endblock %}
