{% extends 'base.html.twig' %}

{% block title %}
	{{ post.title }}
{% endblock %}

{% block stylesheets %}
	<style>
		.star-rating {
			--star-size: 2rem;
			display: inline-flex;
			flex-direction: row-reverse;
			font-size: var(--star-size);
			line-height: 1;
		}
		.star-rating input {
			display: none;
		}
		.star-rating label {
			color: #ddd;
			cursor: pointer;
			transition: color 0.2s;
		}
		.star-rating label:hover,
		.star-rating label:hover ~ label,
		.star-rating input:checked ~ label {
			color: #ffd700;
		}
		.rating-card {
			border-left: 4px solid #ffd700;
			background: #f8f9fa;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container mt-5">
		<article class="blog-post">
			<h1 class="mb-4">{{ post.title }}</h1>

			<div class="meta mb-4 text-muted">
				Par
				{{ post.author.pseudo }}
				•
				{{ post.createdAt|date('d/m/Y H:i') }}
			</div>

			<div class="content mb-5">
				{{ post.content|nl2br }}
			</div>

			<div class="rating-section">
				<div class="average-rating alert alert-info">
					<h4>Note moyenne :
						{{ averageRating|number_format(1) }}/5</h4>
					<small class="text-muted">Basé sur
						{{ ratings|length }}
						avis</small>
				</div>

				{% if not hasRated and app.user != post.author %}
					<div class="rating-form card p-4 mb-5">
						<h4>Ajouter votre avis</h4>
						{# Dans la section du formulaire #}
						{{ form_start(ratingForm) }}
						<div class="star-rating mb-3">
							{% for i in 5..1 %}
								<input type="radio" id="star{{ i }}" name="{{ ratingForm.score.vars.full_name }}" value="{{ i }}" {% if ratingForm.score.vars.value == i %} checked {% endif %}/>
								<label for="star{{ i }}">★</label>
							{% endfor %}
						</div>
						{{ form_errors(ratingForm.score) }}
						{# Affiche les erreurs du score #}
						{{ form_row(ratingForm.comment) }}
						{{ form_rest(ratingForm) }}
						{# Inclut le token CSRF #}
						<button class="btn btn-primary">Publier</button>
						{{ form_end(ratingForm) }}
					</div>
				{% endif %}

				{% if ratings|length > 0 %}
					<div class="user-ratings">
						<h4>Avis des utilisateurs :</h4>
						{% for rating in ratings %}
							<div class="card rating-card mb-3">
								<div class="card-body">
									<div class="star-rating-static text-warning">
										{% for i in 1..5 %}
											{% if i <= rating.score %}
												<span class="text-warning">★</span>
											{% else %}
												<span class="text-muted">★</span>
											{% endif %}
										{% endfor %}
									</div>
									{% if rating.comment %}
										<p class="mt-2">{{ rating.comment }}</p>
									{% endif %}
									<small class="text-muted">
										Par
										{{ rating.rater.pseudo }}, 
																																																																																																				le
										{{ rating.createdAt|date('d/m/Y') }}
									</small>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>
		</article>
	</div>
{% endblock %}
{% block javascripts %}
	<script>
		document.querySelectorAll('.star-rating label').forEach(label => {
label.addEventListener('click', () => {
const inputId = label.getAttribute('for');
const input = document.getElementById(inputId);
if (input) {
input.checked = true;
input.dispatchEvent(new Event('change'));
}
});
});
	</script>
{% endblock %}
